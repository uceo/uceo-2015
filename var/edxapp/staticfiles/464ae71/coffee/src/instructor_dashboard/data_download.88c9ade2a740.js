// Generated by CoffeeScript 1.6.1

/*
Data Download Section

imports from other modules.
wrap in (-> ... apply) to defer evaluation
such that the value can be defined later than this assignment (file load order).
*/


(function() {
  var DataDownload, PendingInstructorTasks, ReportDownloads, std_ajax_err;

  std_ajax_err = function() {
    return window.InstructorDashboard.util.std_ajax_err.apply(this, arguments);
  };

  PendingInstructorTasks = function() {
    return window.InstructorDashboard.util.PendingInstructorTasks;
  };

  DataDownload = (function() {

    function DataDownload($section) {
      var _this = this;
      this.$section = $section;
      this.$section.data('wrapper', this);
      this.$list_studs_btn = this.$section.find("input[name='list-profiles']'");
      this.$list_studs_csv_btn = this.$section.find("input[name='list-profiles-csv']'");
      this.$list_anon_btn = this.$section.find("input[name='list-anon-ids']'");
      this.$grade_config_btn = this.$section.find("input[name='dump-gradeconf']'");
      this.$calculate_grades_csv_btn = this.$section.find("input[name='calculate-grades-csv']'");
      this.$download = this.$section.find('.data-download-container');
      this.$download_display_text = this.$download.find('.data-display-text');
      this.$download_request_response_error = this.$download.find('.request-response-error');
      this.$reports = this.$section.find('.reports-download-container');
      this.$download_display_table = this.$reports.find('.data-display-table');
      this.$reports_request_response = this.$reports.find('.request-response');
      this.$reports_request_response_error = this.$reports.find('.request-response-error');
      this.report_downloads = new ReportDownloads(this.$section);
      this.instructor_tasks = new (PendingInstructorTasks())(this.$section);
      this.clear_display();
      this.$list_anon_btn.click(function(e) {
        var url;
        url = _this.$list_anon_btn.data('endpoint');
        return location.href = url;
      });
      this.$list_studs_csv_btn.click(function(e) {
        var url;
        _this.clear_display();
        url = _this.$list_studs_csv_btn.data('endpoint');
        url += '/csv';
        return $.ajax({
          dataType: 'json',
          url: url,
          error: function(std_ajax_err) {
            _this.$reports_request_response_error.text(gettext("Error generating student profile information. Please try again."));
            return $(".msg-error").css({
              "display": "block"
            });
          },
          success: function(data) {
            _this.$reports_request_response.text(data['status']);
            return $(".msg-confirm").css({
              "display": "block"
            });
          }
        });
      });
      this.$list_studs_btn.click(function(e) {
        var url;
        url = _this.$list_studs_btn.data('endpoint');
        _this.clear_display();
        _this.$download_display_table.text(gettext('Loading'));
        return $.ajax({
          dataType: 'json',
          url: url,
          error: function(std_ajax_err) {
            _this.clear_display();
            return _this.$download_request_response_error.text(gettext("Error getting student list."));
          },
          success: function(data) {
            var $table_placeholder, columns, feature, grid, grid_data, options;
            _this.clear_display();
            options = {
              enableCellNavigation: true,
              enableColumnReorder: false,
              forceFitColumns: true,
              rowHeight: 35
            };
            columns = (function() {
              var _i, _len, _ref, _results;
              _ref = data.queried_features;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                feature = _ref[_i];
                _results.push({
                  id: feature,
                  field: feature,
                  name: data.feature_names[feature]
                });
              }
              return _results;
            })();
            grid_data = data.students;
            $table_placeholder = $('<div/>', {
              "class": 'slickgrid'
            });
            _this.$download_display_table.append($table_placeholder);
            return grid = new Slick.Grid($table_placeholder, grid_data, columns, options);
          }
        });
      });
      this.$grade_config_btn.click(function(e) {
        var url;
        url = _this.$grade_config_btn.data('endpoint');
        return $.ajax({
          dataType: 'json',
          url: url,
          error: function(std_ajax_err) {
            _this.clear_display();
            return _this.$download_request_response_error.text(gettext("Error retrieving grading configuration."));
          },
          success: function(data) {
            _this.clear_display();
            return _this.$download_display_text.html(data['grading_config_summary']);
          }
        });
      });
      this.$calculate_grades_csv_btn.click(function(e) {
        var url;
        _this.clear_display();
        url = _this.$calculate_grades_csv_btn.data('endpoint');
        return $.ajax({
          dataType: 'json',
          url: url,
          error: function(std_ajax_err) {
            _this.$reports_request_response_error.text(gettext("Error generating grades. Please try again."));
            return $(".msg-error").css({
              "display": "block"
            });
          },
          success: function(data) {
            _this.$reports_request_response.text(data['status']);
            return $(".msg-confirm").css({
              "display": "block"
            });
          }
        });
      });
    }

    DataDownload.prototype.onClickTitle = function() {
      this.clear_display();
      this.instructor_tasks.task_poller.start();
      return this.report_downloads.downloads_poller.start();
    };

    DataDownload.prototype.onExit = function() {
      this.instructor_tasks.task_poller.stop();
      return this.report_downloads.downloads_poller.stop();
    };

    DataDownload.prototype.clear_display = function() {
      this.$download_display_text.empty();
      this.$download_display_table.empty();
      this.$download_request_response_error.empty();
      this.$reports_request_response.empty();
      this.$reports_request_response_error.empty();
      $(".msg-confirm").css({
        "display": "none"
      });
      return $(".msg-error").css({
        "display": "none"
      });
    };

    return DataDownload;

  })();

  ReportDownloads = (function() {
    /* Report Downloads -- links expire quickly, so we refresh every 5 mins
    */

    function ReportDownloads($section) {
      var POLL_INTERVAL,
        _this = this;
      this.$section = $section;
      this.$report_downloads_table = this.$section.find(".report-downloads-table");
      POLL_INTERVAL = 20000;
      this.downloads_poller = new window.InstructorDashboard.util.IntervalManager(POLL_INTERVAL, function() {
        return _this.reload_report_downloads();
      });
    }

    ReportDownloads.prototype.reload_report_downloads = function() {
      var endpoint,
        _this = this;
      endpoint = this.$report_downloads_table.data('endpoint');
      return $.ajax({
        dataType: 'json',
        url: endpoint,
        success: function(data) {
          if (data.downloads.length) {
            return _this.create_report_downloads_table(data.downloads);
          } else {
            return console.log("No reports ready for download");
          }
        },
        error: function(std_ajax_err) {
          return console.error("Error finding report downloads");
        }
      });
    };

    ReportDownloads.prototype.create_report_downloads_table = function(report_downloads_data) {
      var $table_placeholder, columns, grid, options;
      this.$report_downloads_table.empty();
      options = {
        enableCellNavigation: true,
        enableColumnReorder: false,
        rowHeight: 30,
        forceFitColumns: true
      };
      columns = [
        {
          id: 'link',
          field: 'link',
          name: gettext('File Name'),
          toolTip: gettext("Links are generated on demand and expire within 5 minutes due to the sensitive nature of student information."),
          sortable: false,
          minWidth: 150,
          cssClass: "file-download-link",
          formatter: function(row, cell, value, columnDef, dataContext) {
            return '<a href="' + dataContext['url'] + '">' + dataContext['name'] + '</a>';
          }
        }
      ];
      $table_placeholder = $('<div/>', {
        "class": 'slickgrid'
      });
      this.$report_downloads_table.append($table_placeholder);
      grid = new Slick.Grid($table_placeholder, report_downloads_data, columns, options);
      return grid.autosizeColumns();
    };

    return ReportDownloads;

  })();

  _.defaults(window, {
    InstructorDashboard: {}
  });

  _.defaults(window.InstructorDashboard, {
    sections: {}
  });

  _.defaults(window.InstructorDashboard.sections, {
    DataDownload: DataDownload
  });

}).call(this);
